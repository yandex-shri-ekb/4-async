define("tree",["d3"],function(e){var t=function(t){t=t||{};var n=document.documentElement.clientWidth-20,r=document.documentElement.clientHeight-20;this.duration=t.duration||100,this.svg=e.select("body").append("svg").style("display","block").attr("width",n).attr("height",r).append("g").attr("transform","translate(10,10)"),this.tree=e.layout.tree().size([n-40,r-40]),this.root={},this.nodes=this.tree(this.root),this.root.parent=this.root,this.root.name="НЛО",this.root.children=[],this.root.px=this.root.x,this.root.py=this.root.y,this.root.avatar="/favicon.ico";var i=this;e.select(window).on("resize",function(){var t=document.documentElement.clientWidth-20,n=document.documentElement.clientHeight-20;e.select("svg").attr("width",t).attr("height",n),i.tree.size([t-40,n-40])})};return t.prototype.addNode=function(e){var t={name:e.name,avatar:e.avatar};if(e.parent===null)n=this.nodes[0];else for(var n,r=0,i=this.nodes.length;r<i;r++)if(this.nodes[r].name===e.parent){n=this.nodes[r];break}return n===undefined?(console.log("Не могу найти родителя узла "+e.name),!1):(n.children?n.children.push(t):n.children=[t],this.nodes.push(t),!0)},t.prototype.update=function(){var t=e.svg.diagonal().projection(function(e){return[e.x,e.y]}),n=this.svg.selectAll(".node").data(this.tree.nodes(this.root),function(e){return e.name}),r=this.svg.selectAll(".link").data(this.tree.links(this.nodes),function(e){return e.source.name+"-"+e.target.name}),i=n.enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.parent.px+","+e.parent.py+")"});i.append("image").attr("xlink:href",function(e){return e.avatar}).attr("x",-12).attr(0/0).attr("opacity",.1).attr("width",24).attr("height",24),i.append("title").text(function(e){return e.name}),r.enter().insert("path",".node").attr("class","link").attr("d",function(e){var n={x:e.source.px,y:e.source.py};return t({source:n,target:n})}).attr("fill","none").attr("stroke","#000");var s=this.svg.transition().duration(this.duration);s.selectAll(".link").attr("d",t),s.selectAll(".node").attr("transform",function(e){return e.px=e.x,e.py=e.y,"translate("+e.x+","+e.y+")"}),s.selectAll("image").attr("opacity",1)},t}),define("ls",[],function(){var e=function(){};return e.prototype.USER_PREFIX="habraUserv2.",e.prototype.loadUser=function(e){return JSON.parse(window.localStorage.getItem(this.USER_PREFIX+e))},e.prototype.saveUser=function(e){window.localStorage.setItem(this.USER_PREFIX+e.name,JSON.stringify(e))},e}),define("app",["jquery","tree","ls"],function(e,t,n){var r=function(r){r=r||{},r.userCount=r.userCount||2,r.blackList=r.blackList||[],this.startUsernames=this.getStartUsernames(r.userCount),e(document.body).html("").css({margin:0}).show(),this.usersUrl=r.usersUrl,this.blackList=r.blackList,this.tree=new t,this.ls=new n,this.queue=[],this.delay=0,this.timeout=500};return r.prototype.start=function(){var t=this;for(var n=0,r=this.startUsernames.length;n<r;n++){if(t.checkUser(this.startUsernames[n]))continue;this.getUserInfo(this.startUsernames[n]).then(function(n){t.findRoot(n).then(function(n){e.proxy(t.addUser(n),t)})})}setInterval(function(){if(t.queue.length>0){var n=t.queue.shift();if(t.checkUser(n))return;t.getUserInfo(n).then(function(n){e.proxy(t.addUser(n),t)})}},100)},r.prototype.checkUser=function(e){return this.blackList.indexOf(e)>-1},r.prototype.addUser=function(e){this.tree.addNode(e),this.tree.update();if(e.children.length>0)for(var t=0,n=e.children.length;t<n;t++)this.queue.push(e.children[t])},r.prototype.findRoot=function(t){var n;if(t.parent){var r=this;return n=this.getUserInfo(t.parent).then(function(e){return r.findRoot(e)}),n}return n=e.Deferred(),n.resolve(t)},r.prototype.getStartUsernames=function(t){var n=e(".username a");for(var r=0,i=[],t=t||n.length;r<t;r++)i.push(n[r].innerHTML);return i},r.prototype.getUserInfo=function(t){var n=e.Deferred(),r=this,i=this.ls.loadUser(t);return i===null?setTimeout(function(){e.get(r.usersUrl+t+"/").then(function(i){r.delay--;var s={};s.name=t,s.avatar=e(i).find(".user_header .avatar img").attr("src"),s.parent=e(i).find("#invited-by").text()||null,s.children=[];var o=e(i).find("#invited_data_items a[rel=friend]");if(o.length>0)for(var u=0,a=o.length;u<a;u++)s.children.push(o[u].innerHTML);r.ls.saveUser(s),n.resolve(s)})},this.delay++*this.timeout):n.resolve(i),n},r}),require.config({waitSeconds:30,paths:{jquery:"//yandex.st/jquery/1.10.2/jquery.min",d3:"http://d3js.org/d3.v3.min",app:"app",ls:"ls",tree:"tree"},shim:{d3:{exports:"d3"}}}),require(["app"],function(e){var t=["Ronnie83","Milla","tangro"],n=new e({usersUrl:"/users/",blackList:t,userCount:+document.body.getAttribute("count")});n.start()}),define("main",function(){});