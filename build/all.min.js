define("tree",["d3"],function(e){var t=function(t){t=t||{};var n=document.documentElement.clientWidth-20,r=document.documentElement.clientHeight-20;this.duration=t.duration||100,this.svg=e.select("body").append("svg").style("display","block").attr("width",n).attr("height",r).append("g").attr("transform","translate(10,10)"),this.tree=e.layout.tree().size([n-40,r-40]),this.root={},this.nodes=this.tree(this.root),this.root.parent=this.root,this.root.name="НЛО",this.root.children=[],this.root.px=this.root.x,this.root.py=this.root.y,this.root.avatar="/favicon.ico";var i=this;e.select(window).on("resize",function(){var t=document.documentElement.clientWidth-20,n=document.documentElement.clientHeight-20;e.select("svg").attr("width",t).attr("height",n),i.tree.size([t-40,n-40])})};return t.prototype.addNode=function(e){var t={name:e.name,avatar:e.avatar},n;if(e.parent===null)n=this.nodes[0];else for(var r=0,i=this.nodes.length;r<i;r++)if(this.nodes[r].name===e.parent){n=this.nodes[r];break}return n===undefined?(console.log("Не могу найти родителя узла "+e.name),!1):(n.children?n.children.push(t):n.children=[t],this.nodes.push(t),!0)},t.prototype.update=function(){var t=e.svg.diagonal().projection(function(e){return[e.x,e.y]}),n=this.svg.selectAll(".node").data(this.tree.nodes(this.root),function(e){return e.name}),r=this.svg.selectAll(".link").data(this.tree.links(this.nodes),function(e){return e.target.name}),i=n.enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.parent.px+","+e.parent.py+")"});i.append("image").attr("xlink:href",function(e){return e.avatar}).attr("x",-12).attr(0/0).attr("opacity",.1).attr("width",24).attr("height",24),i.append("title").text(function(e){return e.name}),r.enter().insert("path",".node").attr("class","link").attr("d",function(e){var n={x:e.source.px,y:e.source.py};return t({source:n,target:n})}).attr("fill","none").attr("stroke","#000");var s=this.svg.transition().duration(this.duration);s.selectAll(".link").attr("d",t),s.selectAll(".node").attr("transform",function(e){return e.px=e.x,e.py=e.y,"translate("+e.x+","+e.y+")"}),s.selectAll("image").attr("opacity",1)},t}),define("cache",[],function(){var e=function(){};return e.prototype.get=function(e){return JSON.parse(window.localStorage.getItem(e))},e.prototype.set=function(e,t){window.localStorage.setItem(e,JSON.stringify(t))},e.prototype.clear=function(){window.localStorage.clear()},e.prototype.count=function(){return window.localStorage.length},e}),define("text!main.css",[],function(){return"html,\nbody\n{\n    font: 14px/normal sans-serif;\n    margin: 0;\n    height: 100%;\n    min-width: 800px;\n}\n\n.dashboard\n{\n    position: absolute;\n    top: 0;\n    left: 0;\n    line-height: 30px;\n    border-bottom: 1px solid #ccc;\n    border-right: 1px solid #ccc;\n}\n\n.group\n{\n    margin: 0 10px;\n}\n\na\n{\n    color: blue;\n    cursor: pointer;\n    text-decoration: none;\n    border-bottom: 1px dotted blue;\n}\n\n.ready .ajax-loader\n{\n    display: none;\n}\n\n.ajax-loader\n{\n    width: 10px;\n    height: 10px;\n    display: inline-block;\n    vertical-align: middle;\n    border: 4px solid #666;\n    border-right-color: transparent;\n    border-radius: 50%;\n    -webkit-animation: spin 1s linear infinite;\n       -moz-animation: spin 1s linear infinite;\n        -ms-animation: spin 1s linear infinite;\n         -o-animation: spin 1s linear infinite;\n            animation: spin 1s linear infinite;\n}\n\n@-webkit-keyframes spin\n{\n    from { -webkit-transform: rotate(0deg); }\n    to   { -webkit-transform: rotate(360deg);  }\n}\n\n@-moz-keyframes spin\n{\n    from { -moz-transform: rotate(0deg); }\n    to   { -moz-transform: rotate(360deg); }\n}\n\n@-ms-keyframes spin\n{\n    from { -ms-transform: rotate(0deg); }\n    to   { -ms-transform: rotate(360deg); }\n}\n\n@-o-keyframes spin\n{\n    from { -o-transform: rotate(0deg); }\n    to   { -o-transform: rotate(360deg); }\n}\n\n@keyframes spin\n{\n    from { transform: rotate(0deg); }\n    to   { transform: rotate(360deg); }\n}"}),define("text!main.html",[],function(){return'<div class="dashboard">\n    <div class="group">\n        <strong>Состояние:</strong>\n        <i class="ajax-loader"></i>\n        <span id="status"></span>\n    </div>\n    <div class="group">\n        <strong>Пользователей в очереди:</strong>\n        <span id="queue-length"></span>\n    </div>\n    <div class="group">\n        <strong>Пользователей в кеше:</strong>\n        <span id="cache-length"></span>\n        <a id="clear-cache">Очистить</a>\n    </div>\n</div>'}),define("app",["jquery","tree","cache","text!main.css","text!main.html"],function(e,t,n,r,i){var s=function(s){this.config=s||{},this.config.userCount=s.userCount||2,this.config.blackList=s.blackList||[],this.startUsernames=this.getStartUsernames(this.config.userCount),e("head").append("<style>"+r+"</style>"),e(document.body).html(i).show(),this.config.gui={statusText:e(s.gui.statusText),queueLength:e(s.gui.queueLength),cacheLength:e(s.gui.cacheLength),clearButton:e(s.gui.clearButton)},this.usersUrl=this.config.usersUrl,this.blackList=this.config.blackList,this.tree=new t,this.cache=new n,this.queue=[],this.delay=0,this.timeout=500,this.USER_PREFIX="habraUserv2.";var o=this;this.config.gui.clearButton.on("click",function(){return o.cache.clear(),o.updateGui(),!1})};return s.prototype.start=function(){var t=this;for(var n=0,r=this.startUsernames.length;n<r;n++){if(t.blackListCheck(this.startUsernames[n]))continue;this.getUserInfo(this.startUsernames[n]).then(function(n){t.findRoot(n).then(function(n){e.proxy(t.addUser(n),t)})})}var i=setInterval(function(){if(t.queue.length>0){var n=t.queue.shift();if(t.queue.indexOf(n)>-1)return;if(t.blackListCheck(n))return;t.getUserInfo(n).then(function(n){e.proxy(t.addUser(n),t)})}},100)},s.prototype.blackListCheck=function(e){return this.blackList.indexOf(e)>-1},s.prototype.addUser=function(e){this.tree.addNode(e),this.tree.update();if(e.children.length>0)for(var t=0,n=e.children.length;t<n;t++)this.queue.push(e.children[t])},s.prototype.findRoot=function(t){var n;if(t.parent){var r=this;return n=this.getUserInfo(t.parent).then(function(e){return r.findRoot(e)}),n}return n=e.Deferred(),n.resolve(t)},s.prototype.getStartUsernames=function(t){var n=e(".username a"),r=[];t=t||n.length;for(var i=0;i<t;i++)r.push(n[i].innerHTML);return r},s.prototype.getUserInfo=function(t){var n=e.Deferred(),r=this,i=this.cache.get(this.USER_PREFIX+t);return i===null?setTimeout(function(){e.get(r.usersUrl+t+"/").then(function(i){r.delay--;var s={};s.name=t,s.avatar=e(i).find(".user_header .avatar img").attr("src"),s.parent=e(i).find("#invited-by").text()||null,s.children=[];var o=e(i).find("#invited_data_items a[rel=friend]");if(o.length>0)for(var u=0,a=o.length;u<a;u++)s.children.push(o[u].innerHTML);r.cache.set(r.USER_PREFIX+s.name,s),r.updateGui(),n.resolve(s)})},this.delay++*this.timeout):n.resolve(i),this.updateGui(),n},s.prototype.updateGui=function(){var t=this.delay+this.queue.length;this.config.gui.cacheLength.text(this.cache.count());if(t>0){var n="Идёт сканирование";e(document.body).removeClass("ready")}else{var n="Дерево построено";e(document.body).addClass("ready")}this.config.gui.statusText.text(n),this.config.gui.queueLength.text(t)},s}),require.config({waitSeconds:30,paths:{text:"//cdnjs.cloudflare.com/ajax/libs/require-text/2.0.10/text.min",jquery:"//yandex.st/jquery/1.10.2/jquery.min",d3:"http://d3js.org/d3.v3.min",app:"app",cache:"cache",tree:"tree"},shim:{d3:{exports:"d3"}}}),require(["jquery","app"],function(e,t){var n=["Ronnie83","Milla","tangro"],r=new t({usersUrl:"/users/",blackList:n,userCount:+document.body.getAttribute("count"),gui:{statusText:"#status",queueLength:"#queue-length",cacheLength:"#cache-length",clearButton:"#clear-cache"}});r.start()}),define("main",function(){});