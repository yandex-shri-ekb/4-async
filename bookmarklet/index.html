<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Habr usertree bookmarklet</title>
</head> 
<body>
    <a href="javascript:(function(){;var%20numDependencies=0,loadedDependencies=0;function%20scriptLoaded()%7BloadedDependencies++;if(numDependencies===loadedDependencies)%7BafterDepsLoaded()%7D%7Dfunction%20afterDepsLoaded()%7B(function%20e(t,n,r)%7Bfunction%20s(o,u)%7Bif(!n%5Bo%5D)%7Bif(!t%5Bo%5D)%7Bvar%20a=typeof%20require==%22function%22&&require;if(!u&&a)return%20a(o,!0);if(i)return%20i(o,!0);throw%20new%20Error(%22Cannot%20find%20module%20'%22+o+%22'%22)%7Dvar%20f=n%5Bo%5D=%7Bexports:%7B%7D%7D;t%5Bo%5D%5B0%5D.call(f.exports,function(e)%7Bvar%20n=t%5Bo%5D%5B1%5D%5Be%5D;return%20s(n?n:e)%7D,f,f.exports,e,t,n,r)%7Dreturn%20n%5Bo%5D.exports%7Dvar%20i=typeof%20require==%22function%22&&require;for(var%20o=0;o%3Cr.length;o++)s(r%5Bo%5D);return%20s%7D)(%7B1:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Crawler=require(%22../common/crawler%22),Builder=require(%22../common/builder%22),crawler=new%20Crawler,builder=new%20Builder;crawler.onUserParsed=function(user)%7Bbuilder.addUser(user)%7D;crawler.onLastUserSent=function()%7Bbuilder.stop()%7D;builder.start();crawler.run(2)%7D)()%7D,%7B%22../common/builder%22:3,%22../common/crawler%22:5%7D%5D,2:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;function%20get(url,cache,success,failure,repeat,attempt)%7Bvar%20xhr=new%20XMLHttpRequest;xhr.onreadystatechange=function()%7Bvar%20timeout;if(xhr.readyState!==4)%7Breturn%7Dswitch(xhr.status)%7Bcase%20200:cache.set(url,xhr.responseText);success(xhr.responseText);break;default:timeout=repeat(attempt);if(timeout)%7BsetTimeout(function()%7Bget(url,cache,success,failure,repeat,attempt+1)%7D,timeout)%7Delse%7Bfailure(xhr.status)%7Dbreak%7D%7D;xhr.open(%22GET%22,url,true);xhr.send()%7Dexports.request=function(url,cache,success,failure,repeat)%7Bvar%20item=cache.get(url);if(item)%7Breturn%20success(item)%7Dget(url,cache,success,failure,repeat,1)%7D%7D)()%7D,%7B%7D%5D,3:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Spinner=require(%22./spinner%22),Tree=require(%22./tree%22),tree_el=document.querySelector(%22.tree%22),Builder=function()%7Bif(tree_el)%7Btree_el.style.display=%22%22%7Delse%7Bthis.initTemplate();tree_el=document.querySelector(%22.tree%22)%7Dthis.spinner=new%20Spinner(%22.spinner%22);this.users=%5B%5D;this.tree=new%20Tree(%22.container%22)%7D;Builder.prototype.start=function()%7Bthis.spinner.start()%7D;Builder.prototype.addUser=function(new_user)%7Bnew_user.children=%5B%5D;this.users.forEach(function(user)%7Bif(!user.children)%7Buser.children=%5B%5D%7Dif(user.url===new_user.parent_url&&user.children.indexOf(new_user)===-1)%7Buser.children.push(new_user)%7Dif(new_user.children_urls.indexOf(user.url)!==-1&&new_user.children.indexOf(user)===-1)%7Bnew_user.children.push(user)%7D%7D);this.users.push(new_user);this.tree.update(%7Bname:%22%22,children:this.users.filter(function(user)%7Breturn!user.parent_url%7D)%7D);console.log(%22User%20parsed%22,new_user)%7D;Builder.prototype.stop=function()%7Bconsole.log(%22Last%20user%20sent%22);document.querySelector(%22.progress%22).style.display=%22none%22;document.querySelector(%22.done%22).style.display=%22inherit%22;this.spinner.stop()%7D;Builder.prototype.initTemplate=function()%7Bvar%20tpl='%3Csection%20class=%22tree%22%3E'+%22%3Cstyle%3E%22+%22.tree%20%7B%22+%22position:%20absolute;%22+%22top:%200;%22+%22right:%200;%22+%22background:%20white;%22+%22border:%201px%20solid%20#ccc;%22+%22text-align:%20left;%22+%22padding:%2010px%2020px%2010px%2010px;%22+%22min-width;%20250px;%22+%22%7D%22+%22.container%20%7B%22+%22margin:%2010px%200%200;%22+%22color:%20#333;%22+%22%7D%22+%22.close%20%7B%22+%22position:%20absolute;%22+%22right:%2010px;%22+%22top:%205px;%22+%22cursor:%20pointer;%22+%22%7D%22+%22.done%20%7B%22+%22display:%20none;%22+%22%7D%22+%22%3C/style%3E%22+'%3Cspan%20class=%22close%22%3E%C3%97%3C/span%3E'+'%3Cspan%20class=%22progress%22%3E%D0%98%D0%B7%D1%83%D1%87%D0%B0%D0%B5%D0%BC%20%D0%B3%D0%B5%D0%BD%D0%B5%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8%D1%8E%20%3Cspan%20class=%22spinner%22%3E%3C/span%3E%3C/span%3E'+'%3Cspan%20class=%22done%22%3E%D0%92%D0%BE%D1%82%20%D0%B8%20%D0%B2%D1%81%D1%91.%3C/span%3E'+'%3Cdiv%20class=%22container%22%3E%3C/div%3E'+%22%3C/section%3E%22;document.body.innerHTML+=tpl;document.querySelector(%22.close%22).addEventListener(%22click%22,function()%7Btree_el.parentElement.removeChild(tree_el)%7D,false)%7D;module.exports=Builder%7D)()%7D,%7B%22./spinner%22:8,%22./tree%22:9%7D%5D,4:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Cache=function(label)%7Bthis.label=label;this.storage=localStorage%5Bthis.label%5D?JSON.parse(localStorage%5Bthis.label%5D):%7B%7D%7D;Cache.prototype.get=function(key)%7Breturn%20this.storage%5Bkey%5D%7D;Cache.prototype.set=function(key,value)%7Bthis.storage%5Bkey%5D=value;this.save()%7D;Cache.prototype.empty=function()%7Bthis.storage=%7B%7D;this.save()%7D;Cache.prototype.save=function()%7BlocalStorage%5Bthis.label%5D=JSON.stringify(this.storage)%7D;module.exports=Cache%7D)()%7D,%7B%7D%5D,5:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Queue=require(%22./queue%22),Cache=require(%22./cache%22),parser=require(%22./parser%22),async=require(%22./async%22),Crawler=function()%7Bthis.cache=new%20Cache(%22users%22);this.queue=new%20Queue;this.retry_timeout=5e3;this.max_retry_attempts=5%7D;Crawler.prototype.run=function(user_number)%7Bvar%20self=this;this.queue.empty();parser.getUsersUrls(document,user_number).forEach(function(url)%7Bthis.handleUser(url)%7D.bind(this))%7D;Crawler.prototype.processUser=function(user)%7Bif(user)%7Bif(user.parent_url)%7Bthis.handleUser(user.parent_url)%7Duser.children_urls.forEach(function(child)%7Bthis.handleUser(child)%7D.bind(this));if(typeof%20this.onUserParsed===%22function%22)%7Bthis.onUserParsed(user)%7D%7Dthis.queue.setLabel(user.url,%22processed%22);if(this.queue.allHaveLabel(%22processed%22))%7Bif(typeof%20this.onLastUserSent===%22function%22)%7Bthis.onLastUserSent()%7D%7D%7D;Crawler.prototype.handleUser=function(url,timeout,attempt)%7Bvar%20self=this;timeout=timeout%7C%7Cthis.retry_timeout;attempt=attempt%7C%7C1;if(this.queue.contains(url))%7Breturn%7Dthis.queue.put(url);async.request(url,this.cache,function(html)%7Bself.processUser(parser.getUser(html))%7D,function(status)%7Bself.queue.take(url)%7D,function(attempt)%7Breturn%20attempt%3Cself.max_retry_attempts?self.retry_timeout*attempt:false%7D)%7D;module.exports=Crawler%7D)()%7D,%7B%22./async%22:2,%22./cache%22:4,%22./parser%22:6,%22./queue%22:7%7D%5D,6:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;exports.getUsersUrls=function(html,number)%7Bvar%20node_list=html.querySelectorAll(%22.username%20%3E%20a%22),node_array=Array.prototype.slice.call(node_list);return%20node_array.slice(0,number).map(function(node)%7Breturn%22http://habrahabr.ru%22+node.getAttribute(%22href%22)%7D)%7D;exports.getUser=function(html)%7Bvar%20context=document.createElement(%22div%22),html_nobr=html.replace(/(%5Cr%5Cn%7C%5Cn%7C%5Cr)/gm,%22%22),html_body=(new%20RegExp(%22%3Cbody%3E(.+)%3C/body%3E%22)).exec(html_nobr)%5B1%5D;context.innerHTML=html_body;var%20username_el=context.querySelector(%22h2.username%22);if(!username_el)%7Breturn%20null%7Dvar%20children_list=context.querySelectorAll('li:not(.banned)%20%3E%20%5Brel=%22friend%22%5D'),children_array=Array.prototype.slice.call(children_list);return%7Burl:context.querySelector(%22.avatar%22).getAttribute(%22href%22),name:username_el.textContent,img:context.querySelector('img%5Balt=%22avatar%22%5D').getAttribute(%22src%22),parent_url:context.querySelector(%22#invited-by%22)&&context.querySelector(%22#invited-by%22).getAttribute(%22href%22),children_urls:children_array.map(function(child)%7Breturn%20child.getAttribute(%22href%22)%7D)%7D%7D%7D)()%7D,%7B%7D%5D,7:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Queue=function()%7Bthis.storage=%5B%5D;this.labels=%7B%7D%7D;Queue.prototype.contains=function(value)%7Breturn%20this.storage.indexOf(value)!==-1%7D;Queue.prototype.put=function(value)%7Bthis.storage.push(value)%7D;Queue.prototype.take=function(value)%7Bvar%20index;while(true)%7Bindex=this.storage.indexOf(value);if(index===-1)%7Bbreak%7Dthis.storage.splice(index,1)%7D%7D;Queue.prototype.isEmpty=function()%7Breturn%20this.storage.length===0%7D;Queue.prototype.empty=function()%7Bthis.storage=%5B%5D%7D;Queue.prototype.setLabel=function(value,label)%7Bif(!this.contains(value))%7Bthrow%20Error(%22Queue%20does%20not%20contains%20%22+value)%7Dif(!this.labels%5Blabel%5D)%7Bthis.labels%5Blabel%5D=%5B%5D%7Dthis.labels%5Blabel%5D.push(value)%7D;Queue.prototype.hasLabel=function(value,label)%7Bif(!this.contains(value))%7Bthrow%20Error(%22Queue%20does%20not%20contains%20%22+value)%7Dreturn%20this.labels%5Blabel%5D&&this.labels%5Blabel%5D.indexOf(value)!==-1%7D;Queue.prototype.allHaveLabel=function(label)%7Breturn%20this.storage.every(function(item)%7Breturn%20this.hasLabel(item,label)%7D.bind(this))%7D;module.exports=Queue%7D)()%7D,%7B%7D%5D,8:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20Spinner=function(container)%7Bthis.stage=0;this.timeout=200;this.container_el=document.querySelector(container)%7D;Spinner.prototype.stages=%5B%22/%22,%22-%22,%22%5C%5C%22,%22%7C%22%5D;Spinner.prototype.start=function()%7Bvar%20self=this;this.stop();this.interval=setInterval(function()%7Bself.container_el.textContent=self.stages%5Bself.stage%5D;self.stage=(self.stage+1)%25self.stages.length%7D,this.timeout)%7D;Spinner.prototype.stop=function()%7BclearInterval(this.interval);this.container_el.textContent=%22%22;this.stage=0%7D;module.exports=Spinner%7D)()%7D,%7B%7D%5D,9:%5Bfunction(require,module,exports)%7B(function()%7B%22use%20strict%22;var%20AsciiTreeProvider=function(container)%7Bvar%20container_el=document.querySelector(container),objLength,drawLeaf,drawTree;objLength=function(obj)%7Bvar%20length=0,i;for(i%20in%20obj)%7Bif(obj.hasOwnProperty(i))%7Blength+=1%7D%7Dreturn%20length%7D;drawLeaf=function(level,value,isLastChild)%7Bvar%20prefix=level===0?%22%22:isLastChild?%22%E2%94%97%20%22:%22%E2%94%9D%20%22,leaf_el=document.createElement(%22div%22);while(level%3E1)%7Bprefix=%22%E2%94%83%20%22+prefix;level-=1%7Dleaf_el.textContent=prefix+value;container_el.appendChild(leaf_el)%7D;drawTree=function(level,tree)%7Bvar%20length=objLength(tree.children),i;for(i%20in%20tree.children)%7Bif(tree.children.hasOwnProperty(i))%7Blength-=1;drawLeaf(level,tree.children%5Bi%5D.name,length===0);drawTree(level+1,tree.children%5Bi%5D)%7D%7D%7D;return%7Bupdate:function(source)%7Bcontainer_el.textContent=%22%22;drawTree(0,source)%7D%7D%7D,Tree=function(container)%7Bthis.provider=new%20AsciiTreeProvider(container)%7D;Tree.prototype.update=function(source)%7Bthis.provider.update(source)%7D;module.exports=Tree%7D)()%7D,%7B%7D%5D%7D,%7B%7D,%5B1%5D)%7DafterDepsLoaded();})()">Build Habr usertree</a>
</body>
</html>